#!bin/python
"""

"""
from __future__ import division
import sys, time, glob, logging, json
import gobject, gtk, numpy
from gtk.gtkgl.apputils import GLArea
from twisted.python.util import sibpath

sys.path.append("OpenCV-2.3.1/lib") # for cv2
sys.path.append("../webcam2") # for v4laccess

from gamescene import GameScene
from play import GameState
from vision import BlockHues, VideoPipeline, VideoControls
from sound import Sound

gobject.threads_init()

logging.basicConfig(level=logging.INFO)
log = logging.getLogger()

numpy.set_printoptions(precision=4, linewidth=200, suppress=True,
                       threshold=4000)

def logTime(func):
    def inner(*args, **kw):
        t1 = time.time()
        try:
            ret = func(*args, **kw)
        finally:
            log.info("Call to %s took %.1f ms" % (
                func.__name__, 1000 * (time.time() - t1)))
        return ret
    return inner

def debug():
    from IPython.frontend.terminal.interactiveshell import TerminalInteractiveShell
    shell = TerminalInteractiveShell(user_ns=vars())
    shell.mainloop()

def addToolbar(wtree, label, cb):
    but1 = gtk.ToolButton(label=label)
    wtree.get_object("toolbar1").insert(but1, -1)
    but1.connect("clicked", cb)
    but1.show()

def swapInGlArea(wtree, widgetName, ga):
    oldGa = wtree.get_object(widgetName)
    ga.set_size_request(*oldGa.get_size_request())
    p = oldGa.get_parent()
    oldGa.destroy()
    p.add(ga)
    ga.show()

class Config(object):
    def __init__(self, wtree, blockHues, videoControls):
        self.wtree, self.blockHues = wtree, blockHues
        self.videoControls = videoControls
        
    def load(self):
        self.config = json.load(open("config.json"))
        self.adjKeys = self.config['adjustments'].keys()
        for k in self.adjKeys:
            adj = self.wtree.get_object(k)
            adj.set_value(self.config['adjustments'][k])
            adj.connect("value-changed", self.save)

        for k, adj in self.blockHues.adjs.items():
            adj.set_value(self.config['hues'][k])
            adj.connect("value-changed", self.save)

        # write to camera
        vals = self.config.get('cameras', {}).get(
            self.videoControls.devicePath, {})
        for n, adj in self.videoControls.adjs.items():
            if n in vals:
                adj.set_value(vals[n])
            adj.connect("value-changed", self.save)
        self.save() # to get the camera controls written
            
    def save(self, *args):
        adjs = dict((k, self.wtree.get_object(k).get_value())
                    for k in self.adjKeys)
        hues = dict((color, adj.get_value())
                    for (color, adj) in self.blockHues.adjs.items())

        # read from camera (that got adjusted by v4lucp?), write to
        # only the changed cam setting
        
        self.config.update({"adjustments":adjs, "hues":hues})
        self.config.setdefault('cameras', {}).update({
            self.videoControls.devicePath :
            dict((n, adj.get_value()) for (n, adj) in
                 self.videoControls.adjs.items())})
        f = open("config.json", "w")
        f.write(json.dumps(self.config, indent=2))
        f.close()

def main():
    sound = Sound(enabled=True)
    state = GameState(sound)

    wtree = gtk.Builder()
    wtree.add_from_file(sibpath(__file__, "ui.glade"))
    mainwin = wtree.get_object("MainWindow")
    mainwin.connect("destroy", gtk.main_quit)
    mainwin.show_all()

    addToolbar(wtree, "Force match", lambda tb: state.forceMatch())
    addToolbar(wtree, "Start timed game", lambda tb: state.startTimedGame())

    bs = BlockHues(wtree.get_object("blockHues"))


    gameScene = GameScene()
    state.scene = gameScene
    state.setScore = wtree.get_object("score").set_label
    state.setGameDesc = wtree.get_object("gameDesc").set_label
    ga = GLArea(gameScene)
    swapInGlArea(wtree, "gameArea", ga)

    dev = glob.glob("/dev/v4l/by-id/*")[0]
    vp = VideoPipeline(dev, wtree.get_object("rawVideo"),
                       wtree.get_object("hueVideo"),
                       wtree.get_object("hueMatchVideo"),
                       wtree.get_object("blobBox"),
                       adjGet=lambda n: wtree.get_object(n).get_value(),
                       blockHues=bs,
                       onFrame=state.onFrame,
                       cameraArea=wtree.get_object("cameraArea"),
                       pipelineSection=wtree.get_object("pipelineSection"),
                       )
    vc = VideoControls(dev, # could get this from the pipeline i presume
                       wtree.get_object("v4lControls"))

    config = Config(wtree, bs, vc)
    config.load()

    state.start()

    gobject.idle_add(sound.idle)
    gtk.main()

main()
